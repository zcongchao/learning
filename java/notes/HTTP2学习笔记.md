# HTTP2 学习笔记

## 1. HTTP 1.1 的现状

- 过于庞大，包含了太多细节和可选内容

- 未能被充分利用的TCP

- 对网络延迟非常敏感，部分原因时HTTP Pipelining还存在很多问题，近几年来网络带宽增长非常快，但是网络延迟却没有对应程度的降低，这样的环境中，即使拥有高连接速率，也很难获得优质快速的网络体验

- 近年来加载网站首页接受的数据量在逐渐增加，超过了 2MB，且平均每个页面为了完成渲染需要加载超过100个独立资源

- 线头阻塞(Head of line blocking):

  HTTP Pipelining(HTTP管线化)是这样一种技术: 把多个HTTP请求放到一个TCP连接中一一发送，而在发送过程中不需要等待服务器对前一个请求的响应，但是服务端还是要按照发送请求的顺序来接收响应。

  服务器是要按照顺序处理请求的，如果前一个请求非常耗时，那么后续的请求都会受到影响，这就是线头阻塞。

  你可以选择一个请求较少的TCP连接发送数据，也可以新建一个TCP连接，一旦选定了TCP连接之后，不能更换。

  但是新建TCP连接的开销非常大，靠大量新建连接是不能有效解决延迟问题的，即HTTP Pipelining并不能彻底解决线头阻塞的问题。

  所以，时至今日，大部分桌面浏览器仍然会选择默认关闭HTTP Pipelining这一功能



## 2. HTTP 1.1 克服延迟之道

### 2.01 Spriting

- Spriting是一种将很多较小的图片合并成一张大图，再用JavaScript或者CSS将小图重新“切割”出来的技术。

  因为在HTTP 1.1里，下载一张大图比下载多张小图快得多，所以网站可以利用这一技巧来提速。

  但是当某些页面只需要显示其中几张小图时，也需要将整张大图从cache里取出来，而不能将最频繁使用的那些图片保留在cache里。



### 2.02 内联(lnlining) 

- lnlinning是另一种防止发送很多小图请求的技巧，他将原始数据嵌入在CSS文件里面的url中。而这种方案的优缺点和Spriting很类似

  ```css
  .icon1 {
    background: url(data:image/png;base64;<data>) no-repeat;
  }
  .icon2 {
    background: url(data:image/png;base64;<data>) no-repeat;
  }
  ```



### 2.03 拼接(Concatenation)

- 拼接是把大量的JavaScript文件合并为一个大文件的技术。

  大型网站往往会包含大量的JavaScript文件，拼接技术能让浏览器只花费一个请求就将JavaScript文件下载完，而不用发无数请求去分别下载那些琐碎的JavaScript文件。

  但是如果网页只需要其中一小部分代码，它也必须下载完整的那份，而文件中一个小小的改动也会造成大量数据的被重新下载



### 2.04 分片(Sharding)

- Sharding是把服务分散在尽可能多的主机上

  最初的HTTP 1.1规范提到一个客户端最多只能对同一主机建立两个TCP连接，为了不和规范冲突，一些网站使用了多台主机，这样的话，用户就能和网站建立更多的连接，从而降低载入时间。

  后来的HTTP 1.1规范将连接数上限进行了调整，可以建立6-8个TCP连接，然而限制依然存在，随着资源个数的提升，网站会需要更多的连接来保证HTTP协议的效率，从而提升载入速度。现今的网站上，使用50甚至100个连接来打开一个页面已经并不罕见

  另外一个将图片或者其他资源分发到不同主机的理由是可以不使用cookies，毕竟现今cookies的大小已经非常可观了。无cookies的图片服务器往往意味着更小的HTTP请求以及更好的性能。